#!/usr/bin/env ruby

require '../common'
require 'objective-j'
require 'rake'
require 'rake/clean'

require 'fileutils'

$ENVIRONMENT_NARWHAL_PRODUCT = $ENVIRONMENT_DIR
$ENVIRONMENT_BROWSERJS_PRODUCT = File.join($ENVIRONMENT_NARWHAL_PRODUCT, 'packages', 'browserjs')
$ENVIRONMENT_JACK_PRODUCT = File.join($ENVIRONMENT_NARWHAL_PRODUCT, 'packages', 'jack')

file_d $ENVIRONMENT_DIR do
  mkdir_p $ENVIRONMENT_DIR
end

task :update_submodules do
  if executable_exists? "git"
    system %{cd .. && git submodule init && git submodule update}
  else
    puts "Git not installed"
    rake abort
  end
end

task :build => [:update_submodules, $ENVIRONMENT_DIR] do
  rm_rf($ENVIRONMENT_NARWHAL_PRODUCT)
  cp_r('narwhal', $ENVIRONMENT_NARWHAL_PRODUCT)
  cp_r('browserjs', $ENVIRONMENT_BROWSERJS_PRODUCT)
  cp_r('jack', $ENVIRONMENT_JACK_PRODUCT)
  symlink_executable(File.join($ENVIRONMENT_JACK_PRODUCT, "bin", "jackup"))
end

CLOBBER.include($ENVIRONMENT_NARWHAL_PRODUCT)
